{% extends "base.html" %}

{% block content %}
<div class="dashboard-container" style="padding: 20px; max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1>üìÑ My Reports</h1>
    </div>

    <div id="reports-list" class="items-grid">
        <div class="loading-message">Loading reports...</div>
    </div>

    <div id="empty-state" class="empty-state" style="display: none; text-align: center; padding: 60px 20px;">
        <h3>üìã No Reports Yet</h3>
        <p>Create your first report by saving a widget from the dashboard.</p>
        <a href="/" class="btn-primary" style="margin-top: 20px;">Go to Dashboard</a>
    </div>
</div>

<script>
    async function loadReports() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        try {
            const response = await fetch('/api/reports', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/login';
                return;
            }

            if (!response.ok) {
                throw new Error('Failed to load reports');
            }

            const reports = await response.json();
            const container = document.getElementById('reports-list');
            const emptyState = document.getElementById('empty-state');

            if (reports.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';
            container.innerHTML = reports.map(report => `
                <div class="item-card">
                    <div class="item-card-header">
                        <h3>${escapeHtml(report.name)}</h3>
                        <button class="btn-icon btn-danger delete-btn" data-id="${report.id}" title="Delete">üóëÔ∏è</button>
                    </div>
                    <div class="item-card-body">
                        <p class="item-meta">Widget Type: ${report.widget_config && report.widget_config.type ? report.widget_config.type : 'N/A'}</p>
                        <p class="item-meta">Filters: ${report.filters ? report.filters.length : 0}</p>
                        <p class="item-meta">Updated: ${new Date(report.updated_at).toLocaleDateString()}</p>
                    </div>
                    <div class="item-card-actions">
                        <button class="btn-primary view-btn" data-id="${report.id}">View</button>
                    </div>
                </div>
            `).join('');

            // Attach event listeners
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    loadReport(id);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    deleteReport(id);
                });
            });

        } catch (error) {
            console.error('Error loading reports:', error);
            document.getElementById('reports-list').innerHTML = 
                '<div class="error-message">Failed to load reports. Please try again.</div>';
        }
    }

    async function loadReport(id) {
        const token = localStorage.getItem('token');
        try {
            const response = await fetch(`/api/reports/${id}`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) throw new Error('Failed to load report');

            const report = await response.json();
            
            // Store report info in sessionStorage for the dashboard to pick up
            sessionStorage.setItem('loadReport', JSON.stringify(report));

            // Redirect to dashboard
            window.location.href = '/';
        } catch (error) {
            console.error('Error loading report:', error);
            alert('Failed to load report');
        }
    }

    async function deleteReport(id) {
        const warning = '‚ö†Ô∏è WARNING: Deleting this report will permanently remove it. This report is independent and will NOT affect any dashboards where similar widgets may exist. This action cannot be undone.\n\nAre you sure you want to proceed?';
        if (!confirm(warning)) {
            return;
        }

        const token = localStorage.getItem('token');
        try {
            const response = await fetch(`/api/reports/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                throw new Error(errorData.detail || 'Failed to delete report');
            }

            // Reload the list
            loadReports();
        } catch (error) {
            console.error('Error deleting report:', error);
            alert(`Failed to delete report: ${error.message}`);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Load on page load
    loadReports();
</script>

<style>
    .items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .item-card {
        background: var(--card-bg, #fff);
        border: 1px solid var(--border-color, #e0e0e0);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .item-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .item-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .item-card-header h3 {
        margin: 0;
        font-size: 1.2em;
        color: var(--text-primary, #333);
    }

    .item-card-body {
        margin-bottom: 15px;
    }

    .item-meta {
        font-size: 0.85em;
        color: var(--text-secondary, #999);
        margin: 5px 0;
    }

    .item-card-actions {
        display: flex;
        gap: 10px;
    }

    .loading-message {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary, #666);
    }

    .error-message {
        text-align: center;
        padding: 40px;
        color: var(--error-color, #d32f2f);
    }
</style>
{% endblock %}
