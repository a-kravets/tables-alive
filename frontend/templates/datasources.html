{% extends "base.html" %}

{% block content %}
<div class="dashboard-container" style="padding: 20px; max-width: 1200px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1>üìä My Data Sources</h1>
        <a href="/" class="btn-primary">+ New Data Source</a>
    </div>

    <div id="datasources-list" class="items-grid">
        <div class="loading-message">Loading data sources...</div>
    </div>

    <div id="empty-state" class="empty-state" style="display: none; text-align: center; padding: 60px 20px;">
        <h3>üìã No Data Sources Yet</h3>
        <p>Create your first data source by connecting a Google Sheet on the dashboard.</p>
        <a href="/" class="btn-primary" style="margin-top: 20px;">Go to Dashboard</a>
    </div>
</div>

<script>
    async function loadDataSources() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login';
            return;
        }

        try {
            const response = await fetch('/api/datasources', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (response.status === 401) {
                localStorage.removeItem('token');
                window.location.href = '/login';
                return;
            }

            if (!response.ok) {
                throw new Error('Failed to load data sources');
            }

            const datasources = await response.json();
            const container = document.getElementById('datasources-list');
            const emptyState = document.getElementById('empty-state');

            if (datasources.length === 0) {
                container.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            emptyState.style.display = 'none';
            container.innerHTML = datasources.map(ds => `
                <div class="item-card">
                    <div class="item-card-header">
                        <h3>${escapeHtml(ds.name)}</h3>
                        <button class="btn-icon btn-danger delete-btn" data-id="${ds.id}" title="Delete">üóëÔ∏è</button>
                    </div>
                    <div class="item-card-body">
                        <p class="item-url">${escapeHtml(ds.url)}</p>
                        <p class="item-meta">Created: ${new Date(ds.created_at).toLocaleDateString()}</p>
                    </div>
                    <div class="item-card-actions">
                        <button class="btn-primary load-btn" data-id="${ds.id}">Load</button>
                    </div>
                </div>
            `).join('');

            // Attach event listeners
            document.querySelectorAll('.load-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    loadDataSource(id);
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    deleteDataSource(id);
                });
            });

        } catch (error) {
            console.error('Error loading data sources:', error);
            document.getElementById('datasources-list').innerHTML = 
                '<div class="error-message">Failed to load data sources. Please try again.</div>';
        }
    }

    async function loadDataSource(id) {
        const token = localStorage.getItem('token');
        try {
            const response = await fetch(`/api/datasources/${id}`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) throw new Error('Failed to load data source');

            const datasource = await response.json();
            
            // Store datasource info in sessionStorage for the dashboard to pick up
            sessionStorage.setItem('loadDataSource', JSON.stringify({
                id: datasource.id,
                url: datasource.url,
                config: datasource.config
            }));

            // Redirect to dashboard
            window.location.href = '/';
        } catch (error) {
            console.error('Error loading data source:', error);
            alert('Failed to load data source');
        }
    }

    async function deleteDataSource(id) {
        const warning = '‚ö†Ô∏è WARNING: Deleting this data source will also delete ALL dashboards and reports that were built using it. This action cannot be undone.\n\nAre you sure you want to proceed?';
        if (!confirm(warning)) {
            return;
        }

        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/ce897f32-969d-49d5-9bea-b8444d5f0311',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'datasources.html:deleteDataSource',message:'Delete datasource called',data:{id:id},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
        // #endregion

        const token = localStorage.getItem('token');
        // #region agent log
        fetch('http://127.0.0.1:7242/ingest/ce897f32-969d-49d5-9bea-b8444d5f0311',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'datasources.html:deleteDataSource',message:'Token check',data:{hasToken:!!token},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'D'})}).catch(()=>{});
        // #endregion
        try {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/ce897f32-969d-49d5-9bea-b8444d5f0311',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'datasources.html:deleteDataSource',message:'Before fetch',data:{id:id,url:`/api/datasources/${id}`},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
            // #endregion
            const response = await fetch(`/api/datasources/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/ce897f32-969d-49d5-9bea-b8444d5f0311',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'datasources.html:deleteDataSource',message:'Response received',data:{status:response.status,statusText:response.statusText,ok:response.ok},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'B'})}).catch(()=>{});
            // #endregion

            if (!response.ok) {
                // #region agent log
                fetch('http://127.0.0.1:7242/ingest/ce897f32-969d-49d5-9bea-b8444d5f0311',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'datasources.html:deleteDataSource',message:'Response not ok',data:{status:response.status},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
                // #endregion
                const errorData = await response.json().catch(() => ({ detail: 'Unknown error' }));
                throw new Error(errorData.detail || 'Failed to delete data source');
            }

            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/ce897f32-969d-49d5-9bea-b8444d5f0311',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'datasources.html:deleteDataSource',message:'Delete successful, reloading list',data:{},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'C'})}).catch(()=>{});
            // #endregion

            // Reload the list
            loadDataSources();
        } catch (error) {
            // #region agent log
            fetch('http://127.0.0.1:7242/ingest/ce897f32-969d-49d5-9bea-b8444d5f0311',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'datasources.html:deleteDataSource',message:'Error caught',data:{error:error.message,stack:error.stack},timestamp:Date.now(),sessionId:'debug-session',runId:'run1',hypothesisId:'A'})}).catch(()=>{});
            // #endregion
            console.error('Error deleting data source:', error);
            alert(`Failed to delete data source: ${error.message}`);
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Load on page load
    loadDataSources();
</script>

<style>
    .items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .item-card {
        background: var(--card-bg, #fff);
        border: 1px solid var(--border-color, #e0e0e0);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .item-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .item-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .item-card-header h3 {
        margin: 0;
        font-size: 1.2em;
        color: var(--text-primary, #333);
    }

    .item-card-body {
        margin-bottom: 15px;
    }

    .item-url {
        font-size: 0.9em;
        color: var(--text-secondary, #666);
        word-break: break-all;
        margin: 5px 0;
    }

    .item-meta {
        font-size: 0.85em;
        color: var(--text-secondary, #999);
        margin: 5px 0;
    }

    .item-card-actions {
        display: flex;
        gap: 10px;
    }

    .loading-message {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary, #666);
    }

    .error-message {
        text-align: center;
        padding: 40px;
        color: var(--error-color, #d32f2f);
    }
</style>
{% endblock %}
